let userLocation=null,branchesData=[],filteredBranches=[],isLocationPermissionGranted=!1,branchesCache=null,cacheExpiry=null,currentLang="ar";const CACHE_DURATION=3e5,translations={ar:{pageTitle:"Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ù‚Ø±Ø¨ ÙØ±Ø¹ LG",subtitle:"Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ ÙØ±Ø¹ LG Ø¥Ù„ÙŠÙƒ ÙÙŠ Ù…ØµØ±",locating:"Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...",locationSuccess:"ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ù†Ø¬Ø§Ø­",locationDenied:"Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø³Ù…Ø­ Ø¨Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„ÙŠØªÙ… Ø¹Ø±Ø¶ Ø£Ù‚Ø±Ø¨ ÙØ±Ø¹",locationError:"Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹",locationUnavailable:"Ø®Ø¯Ù…Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­Ø©",locationTimeout:"Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹",dataError:"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹",noCoordinates:"Ù†Ø¹ØªØ°Ø±ØŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù„Ø¨Ø¹Ø¶ Ø§Ù„ÙØ±ÙˆØ¹",networkError:"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©",nearestBranch:"Ø£Ù‚Ø±Ø¨ ÙØ±Ø¹ Ø¥Ù„ÙŠÙƒ",allBranches:"Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹ Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©",allBranchesNoDistance:"Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹",searchPlaceholder:"Ø§Ø¨Ø­Ø« Ø¹Ù† ÙØ±Ø¹ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...",loadingBranches:"Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ±ÙˆØ¹...",viewOnMap:"Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ø®Ø±Ø§Ø¦Ø·",retry:"Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©",updateLocation:"ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹",youAreAt:"Ø£Ù†Øª Ø§Ù„Ø¢Ù† ÙÙŠ:",nearestIs:"Ø£Ù‚Ø±Ø¨ ÙØ±Ø¹ Ù„Ùƒ Ù‡Ùˆ:",allowLocation:"Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹",locationHint:"Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙˆÙ‚Ø¹Ùƒ ÙÙ‚Ø· Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆÙ„Ù† ÙŠØªÙ… ØªØ®Ø²ÙŠÙ†Ù‡",locationPrompt:"Ù†Ø­ØªØ§Ø¬ Ø¥Ø°Ù†Ùƒ Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø­ØªÙ‰ Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø¹Ø±Ø¶ Ø£Ù‚Ø±Ø¨ ÙØ±Ø¹ LG Ø¥Ù„ÙŠÙƒ",clickToLocate:"Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ ÙˆØªØ±ØªÙŠØ¨ Ø§Ù„ÙØ±ÙˆØ¹ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©",share:"Ù…Ø´Ø§Ø±ÙƒØ©",copied:"ØªÙ… Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ø¹",shareError:"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©",foundBranches:"ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ {count} ÙØ±Ø¹",darkModeOn:"ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ",darkModeOff:"ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ",noInternet:"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",connectionRestored:"ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„",connectionLost:"ÙÙ‚Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„.",newUpdate:"ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯ Ù…ØªØ§Ø­! Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.",displayError:"Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",allGovernorates:"ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª",filterByGovernorate:"ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©",poweredBy:"ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø©",meter:"Ù…ØªØ±",km:"ÙƒÙ…",skipToContent:"Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ",darkModeToggle:"ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ",languageToggle:"English",searchBranches:"Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙØ±ÙˆØ¹",sorry:"Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£",cannotLoad:"Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹"},en:{pageTitle:"Find Nearest LG Branch",subtitle:"Find the nearest LG branch to you in Egypt",locating:"Locating you...",locationSuccess:"Location found successfully",locationDenied:"Please allow location access to show the nearest branch",locationError:"Error getting location",locationUnavailable:"Location service unavailable",locationTimeout:"Location request timed out",dataError:"Error loading branch data",noCoordinates:"Sorry, coordinates not available for some branches",networkError:"Network connection error",nearestBranch:"Nearest Branch",allBranches:"All Branches Sorted by Distance",allBranchesNoDistance:"All Branches",searchPlaceholder:"Search by name or area...",loadingBranches:"Loading branches...",viewOnMap:"View on Maps",retry:"Retry",updateLocation:"Update Location",youAreAt:"You are at:",nearestIs:"Nearest branch:",allowLocation:"Allow Location Access",locationHint:"Your location is only used to calculate distance and is not stored",locationPrompt:"We need your location to show the nearest LG branch",clickToLocate:"Click the button to locate yourself and sort branches by distance",share:"Share",copied:"Branch info copied",shareError:"Error sharing",foundBranches:"Found {count} branches",darkModeOn:"Dark mode enabled",darkModeOff:"Light mode enabled",noInternet:"No internet connection. Please check and try again.",connectionRestored:"Connection restored",connectionLost:"Connection lost. Some features may not work.",newUpdate:"New update available! Reload the page.",displayError:"Error displaying data",allGovernorates:"All Governorates",filterByGovernorate:"Filter by Governorate",poweredBy:"Developed by",meter:"m",km:"km",skipToContent:"Skip to main content",darkModeToggle:"Toggle dark mode",languageToggle:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",searchBranches:"Search branches",sorry:"Sorry, an error occurred",cannotLoad:"Cannot load branch data"}},t=e=>translations[currentLang][e]||translations.ar[e]||e,elements={locationStatus:document.getElementById("locationStatus"),statusMessage:document.getElementById("statusMessage"),statusIcon:document.getElementById("statusIcon"),locationDetails:document.getElementById("locationDetails"),getLocationBtn:document.getElementById("getLocationBtn"),refreshLocationBtn:document.getElementById("refreshLocationBtn"),loadingSkeletonSection:document.getElementById("loadingSkeletonSection"),allBranchesSection:document.getElementById("allBranchesSection"),branchesGrid:document.getElementById("branchesGrid"),errorSection:document.getElementById("errorSection"),errorMessage:document.getElementById("errorMessage"),retryBtn:document.getElementById("retryBtn"),searchInput:document.getElementById("searchInput"),governorateFilter:document.getElementById("governorateFilter"),darkModeToggle:document.getElementById("darkModeToggle"),pageTitle:document.getElementById("page-title")};let currentGovernorate="";const toggleLanguage=async()=>{currentLang="ar"===currentLang?"en":"ar",localStorage.setItem("lg-finder-lang",currentLang),applyLanguage();try{if(showSkeletonLoading(),branchesData=await loadBranchesData(!0),userLocation){const e=calculateAndSortBranches(branchesData,userLocation);await displayResults(e)}else filteredBranches=branchesData,renderBranches(branchesData),elements.allBranchesSection.style.display="block",hideSkeletonLoading();elements.governorateFilter.innerHTML=`<option value="">${t("allGovernorates")}</option>`,populateGovernorateFilter()}catch(e){console.error("Error loading branch data for new language:",e),showError(t("dataError"))}},applyLanguage=()=>{const e=document.documentElement,n="ar"===currentLang;e.setAttribute("lang",currentLang),e.setAttribute("dir",n?"rtl":"ltr"),document.body.style.direction=n?"rtl":"ltr",document.body.style.textAlign=n?"right":"left",document.title=t("pageTitle")+" - LG Egypt";const a=document.querySelector(".main-title");a&&(a.textContent=t("pageTitle"));const o=document.querySelector(".subtitle");if(o&&(o.textContent=t("subtitle")),elements.searchInput&&(elements.searchInput.placeholder=t("searchPlaceholder"),elements.searchInput.setAttribute("aria-label",t("searchBranches"))),elements.governorateFilter){const e=elements.governorateFilter.querySelector('option[value=""]');e&&(e.textContent=t("allGovernorates")),elements.governorateFilter.setAttribute("aria-label",t("filterByGovernorate"))}const r=document.getElementById("getLocationBtn");r&&(r.innerHTML=`\n            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">\n                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>\n            </svg>\n            ${t("allowLocation")}\n        `);const s=document.getElementById("refreshLocationBtn");s&&(s.innerHTML=`\n            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">\n                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>\n            </svg>\n            ${t("updateLocation")}\n        `);const c=document.querySelector(".status-hint");c&&(c.textContent=t("locationHint"));const l=document.getElementById("all-branches-title");l&&(l.textContent=t(userLocation?"allBranches":"allBranchesNoDistance"));const i=document.querySelector("#loadingSkeletonSection .section-title");i&&(i.textContent=t("loadingBranches"));const d=document.querySelector("#errorSection h3");d&&(d.textContent=t("sorry")),elements.retryBtn&&(elements.retryBtn.textContent=t("retry"));const h=document.getElementById("langToggle");h&&(h.textContent=t("languageToggle"),h.setAttribute("aria-label","ar"===currentLang?"Switch to English":"Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©")),elements.darkModeToggle&&(elements.darkModeToggle.setAttribute("aria-label",t("darkModeToggle")),elements.darkModeToggle.setAttribute("title",t("darkModeToggle")));const g=document.querySelector(".skip-link");g&&(g.textContent=t("skipToContent"));const u=document.querySelector(".powered-by");u&&(u.innerHTML=`\n            ${t("poweredBy")}\n            <a href="https://smartstand-eg.com/" target="_blank" rel="noopener noreferrer" class="powered-link">\n                Smart Stand Egypt\n            </a>\n        `),announceToScreenReader("ar"===currentLang?"ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©":"Switched to English")},initLanguage=()=>{const e=localStorage.getItem("lg-finder-lang");!e||"ar"!==e&&"en"!==e||(currentLang=e),applyLanguage()},createIcon=e=>({phone:'<svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>',location:'<svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>',navigation:'<svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>',distance:'<svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M13 1L22 8v2h-2v4.17L22 16v2l-9-7-9 7v-2l2-1.83V10H4V8l9-7z"/></svg>'}[e]||""),updateLocationStatus=(e,t="loading")=>{elements.statusMessage.textContent=e,elements.statusIcon.className=`status-icon ${t}`,"success"===t||"error"===t?(elements.refreshLocationBtn.style.display="flex",elements.refreshLocationBtn.className="success"===t?"btn btn-success":"btn btn-primary"):elements.refreshLocationBtn.style.display="none","success"===t&&(document.title="ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ - Ø£Ù‚Ø±Ø¨ ÙØ±Ø¹ LG")},getUserLocation=()=>new Promise((e,n)=>{if(!navigator.geolocation)return void n(new Error(t("locationUnavailable")));updateLocationStatus(t("locating"));navigator.geolocation.getCurrentPosition(n=>{const a={lat:n.coords.latitude,lng:n.coords.longitude};console.log("User location obtained:",a),isLocationPermissionGranted=!0,updateLocationStatus(t("locationSuccess"),"success"),e(a)},e=>{console.error("Location error:",e);let a=t("locationError");switch(e.code){case e.PERMISSION_DENIED:a=t("locationDenied");break;case e.POSITION_UNAVAILABLE:a=t("locationUnavailable");break;case e.TIMEOUT:a="Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹"}updateLocationStatus(a,"error"),n(new Error(a))},{enableHighAccuracy:!0,timeout:15e3,maximumAge:3e5})}),loadBranchesData=async(e=!1)=>{try{console.log("Loading branches data...");const n=`lg-finder-cache-${currentLang}`,a=e?null:cacheManager.get(n);if(a)return console.log(`Loaded ${a.length} branches from cache (${currentLang})`),a;const o="en"===currentLang?"lg_branches_en.json":"lg_branches_with_coords.json",r=await fetch(o);if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const s=await r.json();console.log(`Loaded ${s.length} branches from server`);const c=s.filter(e=>e.lat&&e.lng&&!isNaN(parseFloat(e.lat))&&!isNaN(parseFloat(e.lng)));if(console.log(`Valid branches: ${c.length}`),0===c.length)throw new Error(t("noCoordinates"));return cacheManager.set(c,n),c}catch(e){throw console.error("Data loading error:",e),new Error(t("dataError"))}},calculateDistance=(e,t,n,a)=>{const o=toRadians(n-e),r=toRadians(a-t),s=Math.sin(o/2)*Math.sin(o/2)+Math.cos(toRadians(e))*Math.cos(toRadians(n))*Math.sin(r/2)*Math.sin(r/2),c=6371*(2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)));return Math.round(100*c)/100},toRadians=e=>e*(Math.PI/180),formatDistance=e=>e<1?`${Math.round(1e3*e)} ${t("meter")}`:`${e} ${t("km")}`,calculateAndSortBranches=(e,t)=>e.map(e=>{const n=calculateDistance(t.lat,t.lng,parseFloat(e.lat),parseFloat(e.lng));return{...e,distance:n}}).sort((e,t)=>e.distance-t.distance),getPlaceName=async(e,t)=>{try{const n=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${e}&lon=${t}&format=json&accept-language=ar`);if(!n.ok)throw new Error("Error connecting to geocoding service");return(await n.json()).display_name||"Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}catch(e){return console.error("Reverse geocoding error:",e),"Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ"}},createNearestBranchCard=e=>`\n        <div class="branch-name">${e.name}</div>\n        <div class="branch-distance">\n            ${createIcon("distance")}\n            ${formatDistance(e.distance)}\n        </div>\n        <div class="branch-info">\n            <div class="branch-address">\n                ${createIcon("location")}\n                ${e.address}\n            </div>\n            <div class="contact-item">\n                ${createIcon("phone")}\n                ${e.phone}\n            </div>\n            ${e.maps_url?`\n                <a href="${e.maps_url}" target="_blank" rel="noopener noreferrer" class="maps-link" aria-label="${t("viewOnMap")} ${e.name}">\n                    ${createIcon("navigation")}\n                    ${t("viewOnMap")}\n                </a>\n            `:""}\n        </div>\n    `,updateNearestBranch=e=>{const t=document.querySelector(".nearest-card");t&&(t.innerHTML=createNearestBranchCard(e))},createBranchCard=(e,n)=>{const a=encodeURIComponent(JSON.stringify({name:e.name,address:e.address,phone:e.phone,maps_url:e.maps_url}));return`\n        <div class="branch-card card fade-in" role="listitem" aria-labelledby="branch-${n}" style="animation-delay: ${.1*n}s">\n            <div class="branch-card-header">\n                <div class="branch-name" id="branch-${n}">${e.name}</div>\n                <button class="share-btn" onclick="shareBranch('${a}')" aria-label="${t("share")} ${e.name}" title="${t("share")}">\n                    <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">\n                        <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/>\n                    </svg>\n                </button>\n            </div>\n            ${e.distance?`\n                <div class="branch-distance">\n                    ${createIcon("distance")}\n                    ${formatDistance(e.distance)}\n                </div>\n            `:""}\n            <div class="branch-address">\n                ${createIcon("location")}\n                ${e.address}\n            </div>\n            <div class="branch-contact">\n                <div class="contact-item">\n                    <span class="contact-icon">${createIcon("phone")}</span>\n                    <span>${e.phone}</span>\n                </div>\n                <div class="contact-item">\n                    <span class="contact-icon">${createIcon("location")}</span>\n                    <span>${e.district} - ${e.governorate}</span>\n                </div>\n            </div>\n            <div class="branch-actions">\n                ${e.maps_url?`\n                    <a href="${e.maps_url}" target="_blank" rel="noopener noreferrer" class="maps-link" aria-label="${t("viewOnMap")} ${e.name}">\n                        ${createIcon("navigation")}\n                        ${t("viewOnMap")}\n                    </a>\n                `:""}\n            </div>\n        </div>\n    `},shareBranch=async e=>{try{const n=JSON.parse(decodeURIComponent(e)),a="ar"===currentLang?"ÙØ±Ø¹ LG":"LG Branch",o=`${a} - ${n.name}\nðŸ“ ${n.address}\nðŸ“ž ${n.phone}`;navigator.share?await navigator.share({title:`${a} - ${n.name}`,text:o,url:n.maps_url||window.location.href}):(await navigator.clipboard.writeText(`${o}\nðŸ—ºï¸ ${n.maps_url||window.location.href}`),showToast(t("copied")))}catch(e){"AbortError"!==e.name&&(console.error("Share error:",e),showToast(t("shareError")))}},showToast=e=>{const t=document.querySelector(".toast");t&&t.remove();const n=document.createElement("div");n.className="toast",n.textContent=e,n.setAttribute("role","alert"),document.body.appendChild(n),setTimeout(()=>n.classList.add("show"),10),setTimeout(()=>{n.classList.remove("show"),setTimeout(()=>n.remove(),300)},3e3)},displayResults=async e=>{try{if(filteredBranches=e,elements.loadingSkeletonSection.style.display="none",e.length>0&&e[0].distance){const n=e[0];if(userLocation){const e=await getPlaceName(userLocation.lat,userLocation.lng);elements.statusMessage.textContent=`${t("youAreAt")} ${e}`,elements.locationDetails.innerHTML=`\n                    <strong>${t("nearestIs")}</strong><br>\n                    ${n.name} (${formatDistance(n.distance)})\n                `,elements.locationDetails.style.display="block"}}renderBranches(e),elements.allBranchesSection.style.display="block";const n=document.getElementById("all-branches-title");n&&(n.textContent=t(userLocation?"allBranches":"allBranchesNoDistance")),console.log(`Displayed ${e.length} branches`)}catch(e){console.error("Display error:",e),showError("Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")}},renderBranches=e=>{const t=e.map((e,t)=>createBranchCard(e,t)).join("");elements.branchesGrid.innerHTML=t},populateGovernorateFilter=()=>{[...new Set(branchesData.map(e=>e.governorate))].sort().forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,elements.governorateFilter.appendChild(t)})},applyFilters=()=>{const e=elements.searchInput.value.trim().toLowerCase();let t=filteredBranches;currentGovernorate&&(t=t.filter(e=>e.governorate===currentGovernorate)),e&&(t=t.filter(t=>t.name.toLowerCase().includes(e)||t.district.toLowerCase().includes(e)||t.governorate.toLowerCase().includes(e)||t.address.toLowerCase().includes(e))),renderBranches(t),announceResults(t.length)},announceResults=e=>{let t=document.getElementById("search-results");t||(t=document.createElement("div"),t.id="search-results",t.className="sr-only",t.setAttribute("aria-live","polite"),document.body.appendChild(t)),t.textContent=`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${e} ÙØ±Ø¹`},filterBranches=e=>{applyFilters()},showSkeletonLoading=()=>{elements.loadingSkeletonSection.style.display="block",elements.allBranchesSection.style.display="none"},hideSkeletonLoading=()=>{elements.loadingSkeletonSection.style.display="none"},showError=e=>{elements.errorMessage.textContent=e,elements.errorSection.style.display="block",elements.allBranchesSection.style.display="none",hideSkeletonLoading()},hideError=()=>{elements.errorSection.style.display="none"},cacheManager={memoryCache:{},set(e,t="lg-finder-cache"){this.memoryCache[t]={data:e,expiry:Date.now()+3e5};try{localStorage.setItem(t,JSON.stringify({data:e,expiry:Date.now()+3e5}))}catch(e){console.warn("Could not save to localStorage:",e)}},get(e="lg-finder-cache"){if(this.memoryCache[e]&&Date.now()<this.memoryCache[e].expiry)return this.memoryCache[e].data;try{const t=localStorage.getItem(e);if(t){const{data:n,expiry:a}=JSON.parse(t);if(Date.now()<a)return this.memoryCache[e]={data:n,expiry:a},n}}catch(e){console.warn("Could not read from localStorage:",e)}return null},clear(e=null){if(e){delete this.memoryCache[e];try{localStorage.removeItem(e)}catch(e){console.warn("Could not clear localStorage:",e)}}else{this.memoryCache={};try{localStorage.removeItem("lg-finder-cache-ar"),localStorage.removeItem("lg-finder-cache-en")}catch(e){console.warn("Could not clear localStorage:",e)}}}},initializeApp=async()=>{try{showSkeletonLoading(),hideError(),console.log("Initializing app..."),branchesData=await loadBranchesData(),populateGovernorateFilter(),filteredBranches=branchesData,renderBranches(branchesData),elements.allBranchesSection.style.display="block",hideSkeletonLoading();const e=document.getElementById("all-branches-title");e&&(e.textContent=t("allBranchesNoDistance")),elements.statusMessage.textContent=t("clickToLocate"),elements.statusIcon.className="status-icon"}catch(e){console.error("App initialization error:",e),showError(e.message)}},requestLocationAndSort=async()=>{try{elements.getLocationBtn.style.display="none",elements.statusMessage.textContent=t("locating"),elements.statusIcon.className="status-icon loading",userLocation=await getUserLocation();const e=calculateAndSortBranches(branchesData,userLocation);await displayResults(e),elements.refreshLocationBtn.style.display="flex"}catch(e){console.warn("Location not available:",e.message),elements.getLocationBtn.style.display="flex",elements.statusMessage.textContent=e.message,elements.statusIcon.className="status-icon error"}},retryLocation=async()=>{try{showSkeletonLoading(),userLocation=await getUserLocation();const e=calculateAndSortBranches(branchesData,userLocation);displayResults(e),hideError()}catch(e){console.error("Location retry failed:",e),updateLocationStatus(e.message,"error"),hideSkeletonLoading()}},initDarkMode=()=>{const e=localStorage.getItem("lg-finder-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;e?document.documentElement.setAttribute("data-theme",e):t&&document.documentElement.setAttribute("data-theme","dark")},toggleDarkMode=()=>{const e="dark"===document.documentElement.getAttribute("data-theme")?"light":"dark";document.documentElement.setAttribute("data-theme",e),localStorage.setItem("lg-finder-theme",e);announceToScreenReader("dark"===e?"ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ":"ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ")},announceToScreenReader=e=>{const t=document.createElement("div");t.setAttribute("role","status"),t.setAttribute("aria-live","polite"),t.className="sr-only",t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.remove(),1e3)},setupEventListeners=()=>{elements.retryBtn.addEventListener("click",initializeApp),elements.getLocationBtn.addEventListener("click",requestLocationAndSort),elements.refreshLocationBtn.addEventListener("click",retryLocation),elements.darkModeToggle.addEventListener("click",toggleDarkMode);const e=document.getElementById("langToggle");let t;e&&e.addEventListener("click",toggleLanguage),elements.governorateFilter.addEventListener("change",e=>{currentGovernorate=e.target.value,applyFilters()}),elements.searchInput.addEventListener("input",e=>{clearTimeout(t),t=setTimeout(()=>{applyFilters()},300)}),elements.searchInput.addEventListener("keydown",e=>{"Escape"===e.key&&(e.target.value="",filterBranches())}),elements.searchInput.addEventListener("keydown",e=>{if("ArrowDown"===e.key){const t=elements.branchesGrid.querySelector(".branch-card");if(t){const n=t.querySelector("a, button");n&&(n.focus(),e.preventDefault())}}})},setupIntersectionObserver=()=>{if("IntersectionObserver"in window){const e=new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting&&(t.target.classList.add("fade-in"),e.unobserve(t.target))})},{threshold:.1,rootMargin:"50px"}),t=()=>{document.querySelectorAll(".branch-card:not(.observed)").forEach(t=>{t.classList.add("observed"),e.observe(t)})};new MutationObserver(()=>{t()}).observe(elements.branchesGrid,{childList:!0})}},setupAccessibilityFeatures=()=>{document.addEventListener("focusin",e=>{(e.target.classList.contains(".branch-card")||e.target.closest(".branch-card"))&&e.target.scrollIntoView({behavior:"smooth",block:"center"})}),document.addEventListener("keydown",e=>{e.altKey&&"s"===e.key&&(elements.searchInput.focus(),e.preventDefault()),e.altKey&&"r"===e.key&&"none"!==elements.refreshLocationBtn.style.display&&(elements.refreshLocationBtn.click(),e.preventDefault())})},handleNetworkError=e=>{console.error("Network error:",e),navigator.onLine?showError(t("networkError")):showError("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")},trackUserEngagement=()=>{isLocationPermissionGranted&&console.log("Location permission granted - enhanced experience enabled");let e=0;elements.searchInput.addEventListener("input",()=>{e++,1===e&&console.log("User engaged with search feature")})},registerServiceWorker=async()=>{if("serviceWorker"in navigator)try{const e=await navigator.serviceWorker.register("/service-worker.js");console.log("[PWA] Service Worker registered:",e.scope),e.addEventListener("updatefound",()=>{const t=e.installing;t.addEventListener("statechange",()=>{"installed"===t.state&&navigator.serviceWorker.controller&&showToast("ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯ Ù…ØªØ§Ø­! Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.")})})}catch(e){console.error("[PWA] Service Worker registration failed:",e)}};document.addEventListener("DOMContentLoaded",()=>{console.log("Enhanced LG Branch Finder initialized"),initDarkMode(),initLanguage(),registerServiceWorker(),setupEventListeners(),setupIntersectionObserver(),setupAccessibilityFeatures(),trackUserEngagement(),initializeApp().catch(e=>{console.error("App initialization failed:",e),handleNetworkError(e)})}),window.addEventListener("online",()=>{console.log("Connection restored"),hideError(),0===branchesData.length&&initializeApp(),updateLocationStatus("ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„","success")}),window.addEventListener("offline",()=>{console.log("Connection lost"),updateLocationStatus("ÙÙ‚Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„.","error")}),document.addEventListener("visibilitychange",()=>{document.hidden?console.log("Page hidden - pausing operations"):(console.log("Page visible - resuming operations"),cacheExpiry&&Date.now()>cacheExpiry&&(console.log("Cache expired, refreshing data"),cacheManager.clear(),navigator.onLine&&initializeApp()))}),window.addEventListener("error",e=>{console.error("Global error:",e.error),e.error&&e.error.message&&!e.error.message.includes("Network")&&!e.error.message.includes("fetch")||showError(t("dataError"))}),window.addEventListener("unhandledrejection",e=>{if(console.error("Unhandled promise rejection:",e.reason),e.preventDefault(),e.reason&&e.reason.message){if(e.reason.message.includes("Location"))return;showError(t("dataError"))}}),"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname||(window.lgBranchFinder={calculateDistance:calculateDistance,formatDistance:formatDistance,getUserLocation:getUserLocation,loadBranchesData:loadBranchesData,cacheManager:cacheManager});